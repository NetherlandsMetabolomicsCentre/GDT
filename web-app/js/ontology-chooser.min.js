/**
 *  Ontology Chooser, use any NCBO ontology with a text input element
 *  Copyright (C) 2010 Jeroen Wesbeek
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
function OntologyChooser(){}OntologyChooser.prototype={cache:[],ctrl:false,noSearch:false,clipboard:[],options:{minLength:1,showHide:null,spinner:"http://www.ajaxload.info/images/exemples/2.gif"},init:function(a){var b=this;if(a){$.each(a,function(c,d){b.options[c]=d})}if(this.options.showHide){this.options.showHide.hide()}$(".ontologySearcher").each(function(){b.initOntologyAutocomplete(this)});$("input[rel*='ontology']").each(function(){b.initAutocomplete(this)})},initAutocomplete:function(d){var f=this;var g=$(d);var e=false;var c=g.attr("rel").split("-");var b=c[1];var a=c[2];if(b=="all"){b=""}g.bind("keydown",function(h){if(h.keyCode==17||h.keyCode==224){f.ctrl=true}if(h.keyCode==13){return false}if(h.keyCode==8&&f.options.showHide){f.options.showHide.hide()}if(h.keyCode==67&&f.ctrl){return f.copy(g)}if(h.keyCode==86&&f.ctrl){return f.paste(g)}});g.bind("keyup",function(h){if(h.keyCode==17||h.keyCode==224){f.ctrl=false}});g.autocomplete({minLength:f.options.minLength,delay:300,search:function(h,i){if(f.noSearch){f.noSearch=false;return false}if(f.options.spinner){g.css({background:"url("+f.options.spinner+") no-repeat right center"})}e=false},source:function(j,h){var k=$.trim(j.term);var i="http://data.bioontology.org/search?q="+k+"&ontologies="+b+"&apikey=c62bc477-a20d-4dc3-802f-92b6d9d78a16";if(f.cache[k]){g.css({background:"none"});h(f.cache[k])}else{$.getJSON(i,function(m){var l=f.parseTerms(m.collection);f.cache[k]=l;g.css({background:"none"});if(!m.collection){if(f.options.showHide){f.options.showHide.hide()}f.setInputValue(g,"ontology_id",null);f.setInputValue(g,"concept_id",null)}h(l)})}},select:function(i,j){e=true;var h=g;f.setInputValue(h,"ontology_id",j.item.ontologyUrl);f.setInputValue(g,"concept_id",j.item.concept_id);h.removeClass("error");if(f.options.showHide){f.options.showHide.show()}},close:function(i,j){if(!e){var h=g;g.val("");f.setInputValue(h,"ontology_id","");f.setInputValue(g,"concept_id","");h.addClass("error")}},html:true}).data("ui-autocomplete")._renderItem=function(h,i){return $("<li></li>").data("item.autocomplete",i).append('<a><span class="about">'+i.value+'</span><span class="from">'+i.ontologyUrl+"</span></a>").appendTo(h)}},initOntologyAutocomplete:function(a){var c=this;var d=$(a);var b=false;d.bind("keydown",function(f){if(f.keyCode==17||f.keyCode==224){c.ctrl=true}if(f.keyCode==13){return false}if(f.keyCode==8&&c.options.showHide){c.options.showHide.hide()}if(f.keyCode==67&&c.ctrl){return c.copy(d)}if(f.keyCode==86&&c.ctrl){return c.paste(d)}});d.bind("keyup",function(f){if(f.keyCode==17||f.keyCode==224){c.ctrl=false}});d.autocomplete({minLength:0,delay:300,search:function(e,f){if(c.noSearch){c.noSearch=false;return false}if(c.options.spinner){d.css({background:"url("+c.options.spinner+") no-repeat right center"})}b=false},source:function(g,e){var h=$.trim(g.term);var f="http://data.bioontology.org/ontologies?apikey=c62bc477-a20d-4dc3-802f-92b6d9d78a16";if(c.cache[h]){d.css({background:"none"});e(c.cache[h])}else{$.getJSON(f,function(j){j=j.filter(function(k){return k.acronym.toLowerCase().indexOf(h.toLowerCase())!=-1});var i=c.parseOntologies(j);c.cache[h]=i;d.css({background:"none"});if(!j.collection){if(c.options.showHide){c.options.showHide.hide()}c.setInputValue(d,"ontology_id",null)}e(i)})}},select:function(f,g){b=true;var e=d;c.setInputValue(e,"ontology_id",g.item.ontologyUrl);e.removeClass("error");if(c.options.showHide){c.options.showHide.show()}},close:function(f,g){if(!b){var e=d;d.val("");c.setInputValue(e,"ontology_id","");e.addClass("error")}},html:true})},setInputValue:function(e,c,d){var a=e.attr("name")+"-"+c;var b=e.parent().find("input[name='"+a+"']");if(b.size()>0){$(b[0]).val(d)}else{e.after('<input type="hidden" name="'+a+'" value="'+d+'"/>')}},getInputValue:function(d,c){var a=d.attr("name")+"-"+c;var b=d.parent().find("input[name='"+a+"']");return(b.size()>0)?$(b[0]).val():""},parseTerms:function(b){var a=[];$.each(b,function(c,d){a[c]={value:d.prefLabel,preferred_name:d.prefLabel,ontologyUrl:d.links.ontology,concept_id:d["@id"]}});return a},parseOntologies:function(b){var a=[];$.each(b,function(c,d){a[c]={value:d.acronym,label:'<span class="about">('+d.acronym+')</span> <span class="from">full name: '+d.name+"</span>",preferred_name:d.acronym,ontologyUrl:d["@id"]}});return a},copy:function(a){this.clipboard={sourceValue:$(a).val(),ontology_id:this.getInputValue(a,"ontology_id"),concept_id:this.getInputValue(a,"concept_id")};return false},paste:function(b){if(this.clipboard.sourceValue&&this.clipboard.concept_id&&this.clipboard.ncbo_id&&this.clipboard.full_id){var a=new RegExp(this.clipboard.ncbo_id);if(b.attr("rel").match(a)||b.attr("rel").match(/all/)){this.noSearch=true;$(b).val(this.clipboard.sourceValue);this.setInputValue(b,"ontology_id",this.clipboard.ontology_id);this.setInputValue(b,"concept_id",this.clipboard.concept_id)}}return false}};